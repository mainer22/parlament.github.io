<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Stalcraft Clan Portal</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, sans-serif;
      background: radial-gradient(circle at center, #00669955 0%, #000000 70%);
      background-attachment: fixed;
      min-height: 100vh;
      color: #e0e0e0;
      position: relative;
      overflow-x: hidden;
    }
    body::before {
      content: '';
      position: fixed;
      top: 50%;
      left: 50%;
      width: 480px;
      height: 480px;
      background: radial-gradient(circle, #00aaff55 0%, #00447733 50%, transparent 70%);
      transform: translate(-50%, -50%);
      z-index: -1;
      animation: pulse 4s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 0.5; transform: translate(-50%, -50%) scale(1); }
      50% { opacity: 0.9; transform: translate(-50%, -50%) scale(1.05); }
    }

    .container { max-width: 1400px; margin: 0 auto; padding: 2rem; position: relative; z-index: 1; }
    
    .glass-card {
      background: rgba(8,12,20,0.85);
      backdrop-filter: blur(24px);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 24px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.8);
    }

    .clan-header {
      padding: 3rem;
      margin-bottom: 3rem;
      text-align: center;
      max-width: 800px;
      margin-left: auto;
      margin-right: auto;
    }
    .clan-title {
      font-size: 3rem;
      font-weight: bold;
      margin-bottom: 2rem;
      background: linear-gradient(45deg, #ffffff, #e0e0e0);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }
    .clan-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 1.5rem;
      margin-top: 2rem;
    }
    .stat-item {
      padding: 1.5rem;
      text-align: center;
      background: rgba(255,255,255,0.06);
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.08);
    }
    .stat-value { font-size: 2.2rem; font-weight: bold; color: #4ecdc4; margin-bottom: 0.5rem; }
    .stat-label { font-size: 0.95rem; opacity: 0.9; }

    .tab-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 1.5rem;
      justify-content: center;
      margin-bottom: 2rem;
      background: rgba(255,255,255,0.04);
      padding: 1.5rem;
      border-radius: 20px;
    }
.tab-btn {
  padding: 1.2rem 2.5rem;
  font-size: 1rem;
  font-weight: 600;
  border: none;
  cursor: pointer;
  background: rgba(255,255,255,0.10);
  border-radius: 16px;
  color: #e0e0e0;
  transition:
    background-color 0.18s ease-out,
    color 0.18s ease-out,
    transform 0.18s ease-out,
    box-shadow 0.18s ease-out;
}

.tab-btn:hover {
  background: rgba(255,255,255,0.25);
  transform: translateY(-3px);
  box-shadow: 0 8px 24px rgba(0,0,0,0.6);
}

.tab-btn.active {
  background: rgba(255,255,255,0.35);
  color: #000;
  transform: translateY(-2px);
}


.tab-content {
  display: none;
  padding: 3rem;
  min-height: 600px;
  margin-bottom: 2rem;

  /* –ø–ª–∞–≤–Ω–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ */
  opacity: 0;
  transform: translateY(8px);
  transition:
    opacity 0.2s ease-out,
    transform 0.2s ease-out;
  will-change: opacity, transform;
}

.tab-content.active {
  display: block;
  opacity: 1;
  transform: translateY(0);
}


    .squad-filter {
      display: flex;
      gap: 1rem;
      margin-bottom: 2rem;
      flex-wrap: wrap;
      background: rgba(255,255,255,0.06);
      padding: 1.5rem;
      border-radius: 16px;
      align-items: center;
      justify-content: space-between;
    }
    .squad-select, .player-search {
      padding: 1rem 1.5rem;
      background: rgba(10,10,10,0.85);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 12px;
      color: white;
    }
    .login-info { font-size: 0.9rem; opacity: 0.8; }

    .players-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(420px, 1fr));
      gap: 2rem;
    }

    .player-modal {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(8,12,20,0.96);
      backdrop-filter: blur(40px);
      border-top: 1px solid rgba(255,255,255,0.12);
      border-radius: 24px 24px 0 0;
      padding: 2rem;
      transform: translateY(100%);
      transition: transform 0.4s ease;
      z-index: 1000;
      max-height: 80vh;
      overflow-y: auto;
    }
    .player-modal.active { transform: translateY(0); }
    .modal-close {
      position: absolute;
      top: 1rem;
      right: 1.5rem;
      font-size: 2rem;
      cursor: pointer;
      color: #fff;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
    }
    .modal-close:hover { background: rgba(255,0,0,0.2); }

    .player-card {
      padding: 2rem;
      cursor: pointer;
      background: rgba(14,20,30,0.9);
      border: 1px solid rgba(255,255,255,0.14);
      border-radius: 16px;
      transition: all 0.3s;
    }
    .player-card:hover {
      background: rgba(22,32,48,0.95);
      transform: translateY(-4px);
      box-shadow: 0 12px 40px rgba(0,0,0,0.6);
    }
    .player-name { font-size: 1.5rem; font-weight: bold; color: #fff; margin-bottom: 0.5rem; }
    .player-rank { color: #4ecdc4; font-size: 1.1rem; margin-bottom: 1.5rem; }
    .player-gear {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
    }
    .gear-item {
      padding: 1rem;
      background: rgba(0,0,0,0.55);
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.16);
      position: relative;
      overflow: visible;
    }
    .gear-label { font-size: 0.8rem; opacity: 0.7; margin-bottom: 0.2rem; }
    .gear-value { font-size: 0.95rem; }

    .gear-item-input, select.gear-item-input {
      padding: 0.7rem 1rem;
      background: rgba(10,10,10,0.9);
      border: 1px solid rgba(255,255,255,0.3);
      border-radius: 8px;
      color: #e0e0e0;
      width: 100%;
      font-size: 0.95rem;
    }
    .gear-item-input:focus { outline: none; box-shadow: 0 0 0 2px rgba(79,205,196,0.6); }

    .build-preview {
      position: absolute;
      top: -10px;
      right: -10px;
      width: 240px;
      max-height: 300px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.3);
      overflow: hidden;
      box-shadow: 0 12px 40px rgba(0,0,0,0.85);
      background: #000;
      display: none;
      z-index: 20;
    }
    .build-preview img {
      width: 100%;
      display: block;
    }

    .maps-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill,minmax(260px,1fr));
      gap: 1.5rem;
    }
    .map-card {
      height: 200px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.18);
      overflow: hidden;
      position: relative;
      cursor: pointer;
      background: rgba(0,0,0,0.6);
      box-shadow: 0 10px 30px rgba(0,0,0,0.7);
      transition: all 0.3s;
    }
    .map-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 16px 40px rgba(0,0,0,0.9);
      border-color: rgba(78,205,196,0.9);
    }
    .map-card img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      opacity: 0.9;
      transition: opacity 0.3s;
    }
    .map-card:hover img { opacity: 1; }
    .map-card-title {
      position: absolute;
      left: 0;
      right: 0;
      bottom: 0;
      padding: 0.5rem 1rem;
      background: linear-gradient(to top, rgba(0,0,0,0.85), transparent);
      font-weight: 600;
      font-size: 1rem;
    }

    .map-modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.75);
      backdrop-filter: blur(12px);
      display: none;
      z-index: 2000;
    }
    .map-modal-backdrop.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .map-modal {
      width: 96vw;
      height: 92vh;
      border-radius: 24px;
      background: rgba(8,12,20,0.96);
      border: 1px solid rgba(255,255,255,0.18);
      box-shadow: 0 24px 80px rgba(0,0,0,0.9);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      position: relative;
    }
    .map-modal-body {
  flex: 1;
  display: flex;
  flex-direction: row;
  gap: 0;
  height: calc(100% - 44px); /* –º–∏–Ω—É—Å –∑–∞–≥–æ–ª–æ–≤–æ–∫ */
}

.map-canvas-wrap {
  flex: 1;
  padding: 0.75rem 1.5rem 1.5rem;
  display: flex;
  align-items: stretch;
  justify-content: center;
}

.map-sidebar {
  width: 220px;
  border-left: 1px solid rgba(255,255,255,0.12);
  padding: 1rem 1.25rem;
  display: flex;
  flex-direction: column;
  gap: 1rem;
  background: radial-gradient(circle at top, rgba(255,255,255,0.04), rgba(0,0,0,0.9));
}

.map-color-block {
  border-radius: 16px;
  padding: 0.75rem 0.75rem 0.9rem;
  background: rgba(0,0,0,0.7);
  border: 1px solid rgba(255,255,255,0.18);
}

.map-color-label {
  font-size: 0.8rem;
  opacity: 0.8;
  margin-bottom: 0.4rem;
}

#toolColor {
  width: 100%;
  height: 40px;
  border-radius: 10px;
  border: none;
  padding: 0;
  background: transparent;
  cursor: pointer;
}

.map-sidebar-section {
  border-radius: 14px;
  padding: 0.75rem;
  background: rgba(0,0,0,0.7);
  border: 1px solid rgba(255,255,255,0.12);
}

.map-sidebar-label {
  font-size: 0.8rem;
  opacity: 0.85;
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 0.4rem;
}

#toolWidth {
  width: 60px;
  background: rgba(15,15,15,0.9);
  border-radius: 8px;
  border: 1px solid rgba(255,255,255,0.3);
  color: #e0e0e0;
  padding: 0.2rem 0.4rem;
  font-size: 0.85rem;
}

.map-tools-vertical {
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
}

.map-tools-vertical .tool-btn {
  width: 100%;
  justify-content: flex-start;
}

    .map-modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.75rem 1.5rem;
      border-bottom: 1px solid rgba(255,255,255,0.12);
      background: linear-gradient(to right, rgba(255,255,255,0.06), transparent);
    }
    .map-modal-title { font-weight: 600; font-size: 1rem; }
    .map-modal-close {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #fff;
      font-size: 1rem;
    }
    .map-modal-close:hover {
      background: rgba(255,80,80,0.4);
      border-color: rgba(255,80,80,0.9);
    }

    /* –Ω–æ–≤—ã–π —Ç—É–ª–±–∞—Ä –∫–∞–∫ –≤ —Ñ–æ—Ç–æ—à–æ–ø–µ: —Å–ª–µ–≤–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã, —Å–ø—Ä–∞–≤–∞ —Å–≤–æ–π—Å—Ç–≤–∞ */
    .map-toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
      padding: 0.5rem 1.5rem;
      background: rgba(255,255,255,0.03);
      border-bottom: 1px solid rgba(255,255,255,0.08);
      flex-wrap: wrap;
    }
    .tools-group, .props-group {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      flex-wrap: wrap;
    }
    .tool-btn {
      padding: 0.35rem 0.8rem;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.35);
      background: rgba(10,10,10,0.9);
      color: #e0e0e0;
      font-size: 0.85rem;
      cursor: pointer;
    }
    .tool-btn.active {
      background: #4ecdc4;
      color: #000;
      border-color: #4ecdc4;
    }

    .map-canvas-wrap {
      flex: 1;
      padding: 0.75rem 1.5rem 1.5rem;
      display: flex;
      align-items: stretch;
      justify-content: center;
    }
    #mapCanvas {
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.22);
      background: #000;
    }
/* —Å–∞–º –±–ª–æ–∫ –≤–∫–ª–∞–¥–∫–∏ –û—Ç—Ä—è–¥—ã */
#squads {
  padding: 2.2rem 2.5rem 2rem; /* —á—É—Ç—å –±–æ–ª—å—à–µ —Å–ª–µ–≤–∞/—Å–ø—Ä–∞–≤–∞ */
}

/* —Å–µ—Ç–∫–∞ –∫–æ–ª–æ–Ω–æ–∫ –æ—Ç—Ä—è–¥–æ–≤ */
.squads-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
  gap: 1.2rem;
  margin-bottom: 1.5rem;      /* –æ—Ç—Å—Ç—É–ø —Å–Ω–∏–∑—É, —á—Ç–æ–±—ã extra –Ω–µ –ø—Ä–∏–ª–∏–ø–∞–ª–∞ */
}

/* –Ω–∏–∂–Ω–∏–π –±–ª–æ–∫ –ó–∞–º–µ–Ω–∞ + –ó–∞–º–µ—Ç–∫–∏ */
.squads-extra {
  display: grid;
  grid-template-columns: minmax(200px, 250px) minmax(260px, 1fr);
  gap: 1.2rem;
  align-items: flex-start;
}
.squads-notes-wrap {
  margin-top: 1.2rem;
  background: rgba(0,0,0,0.7);
  border-radius: 16px;
  border: 1px solid rgba(255,255,255,0.12);
  padding: 0.75rem 0.9rem 1rem;
}

/* –ø—É—Å—Ç—å –¥–æ–ø. –±–ª–æ–∫–∏ –ø–æ —à–∏—Ä–∏–Ω–µ –Ω–µ —Å–∏–ª—å–Ω–µ–µ –æ—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ç–∫–∏ */
.squads-sub-block {
  background: rgba(0,0,0,0.7);
  border-radius: 16px;
  border: 1px solid rgba(255,255,255,0.12);
  padding: 0.75rem 0.9rem 1rem;
  max-width: 100%;
  box-sizing: border-box;
}


.squads-notes {
  margin-top: 0.4rem;
  min-height: 60px;
  max-height: 140px;
  overflow-y: auto;
  padding: 0.5rem 0.6rem;
  border-radius: 10px;
  background: rgba(10,10,10,0.9);
  border: 1px solid rgba(255,255,255,0.16);
  font-size: 0.9rem;
  line-height: 1.4;
  outline: none;
  white-space: pre-wrap;
}

.squads-notes:focus {
  box-shadow: 0 0 0 2px rgba(78,205,196,0.7);
  border-color: rgba(78,205,196,0.9);
}

.squads-notes-hint {
  margin-top: 0.35rem;
  font-size: 0.75rem;
  opacity: 0.6;
}

.squad-column {
  background: rgba(0,0,0,0.7);
  border-radius: 16px;
  border: 1px solid rgba(255,255,255,0.12);
  padding: 0.75rem 0.75rem 0.9rem;
  display: flex;
  flex-direction: column;
}

.squad-column-title {
  font-size: 0.9rem;
  font-weight: 600;
  letter-spacing: 0.02em;
  margin-bottom: 0.5rem;
  padding: 0.25rem 0.5rem;
  border-radius: 10px;
  background: linear-gradient(to right, rgba(255,255,255,0.12), transparent);
}

.squad-column-body {
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
}

.squad-pill {
  padding: 0.25rem 0.55rem;
  border-radius: 999px;
  background: rgba(20,20,30,0.9);
  border: 1px solid rgba(255,255,255,0.16);
  font-size: 0.85rem;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  transition:
    background-color 0.15s ease-out,
    border-color 0.15s ease-out,
    transform 0.12s ease-out,
    box-shadow 0.12s ease-out;
}
.squad-pill:hover {
  background: rgba(78,205,196,0.18);
  border-color: rgba(78,205,196,0.9);
  transform: translateY(-1px);
  box-shadow: 0 0 10px rgba(78,205,196,0.6);
}

    @media (max-width: 768px) { 
      .players-grid { grid-template-columns: 1fr; } 
      .clan-title { font-size: 2rem; } 
    }
    .stat-edit-big {
  font-size: 2.2rem;
  font-weight: 700;
  color: #4ecdc4;
  padding: 0.25rem 0.5rem;
  border-radius: 10px;
  background: rgba(0,0,0,0.55);
  border: 1px solid rgba(255,255,255,0.12);
  min-height: 2.6rem;
  cursor: text;
  outline: none;
  display: inline-block;
  transition:
    box-shadow 0.18s ease-out,
    border-color 0.18s ease-out,
    background-color 0.18s ease-out;
}

.stat-edit-big:focus {
  box-shadow: 0 0 0 2px rgba(78,205,196,0.7);
  border-color: rgba(78,205,196,0.9);
  background: rgba(0,0,0,0.8);
}

.stat-positive {
  color: #00ff85;
}

.stat-negative {
  color: #ff6b6b;
}

    /* –°—Ç–∞—Ä—Ç–æ–≤–∞—è –∞–Ω–∏–º–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Å –∫–ª–∞–Ω–æ–º */
.clan-header {
  opacity: 0;
  transform: translateY(-10px);
  animation: fadeSlideDown 0.4s ease-out forwards;
  animation-delay: 0.05s;
}

/* –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –ª–∏–¥–µ—Ä –ø–æ—è–≤–ª—è—é—Ç—Å—è —á—É—Ç—å —Ä–∞–Ω—å—à–µ */
.clan-title {
  opacity: 0;
  transform: translateY(-6px);
  animation: fadeSlideDown 0.32s ease-out forwards;
  animation-delay: 0.12s;
}

.clan-header > div:nth-of-type(2) { /* –±–ª–æ–∫ "–õ–∏–¥–µ—Ä" */
  opacity: 0;
  transform: translateY(-4px);
  animation: fadeSlideDown 0.3s ease-out forwards;
  animation-delay: 0.16s;
}

/* –±–ª–æ–∫ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –ø–æ—Ç–æ–º */
.clan-stats {
  opacity: 0;
  transform: translateY(4px);
  animation: fadeSlideUp 0.32s ease-out forwards;
  animation-delay: 0.22s;
}

/* —Å–∞–º–∏ —Ç—Ä–∏ –∫–∞—Ä—Ç–æ—á–∫–∏ –≤–Ω—É—Ç—Ä–∏ –ø–æ –æ—á–µ—Ä–µ–¥–∏ */
.clan-stats .stat-item {
  opacity: 0;
  transform: translateY(8px);
  animation: fadeSlideUp 0.26s ease-out forwards;
}

.clan-stats .stat-item:nth-child(1) { animation-delay: 0.26s; }
.clan-stats .stat-item:nth-child(2) { animation-delay: 0.30s; }
.clan-stats .stat-item:nth-child(3) { animation-delay: 0.34s; }

/* —Ç–∞–±‚Äë–∫–Ω–æ–ø–∫–∏ –ø–æ—è–≤–ª—è—é—Ç—Å—è –ø–æ—Å–ª–µ —à–∞–ø–∫–∏ */
.tab-buttons {
  opacity: 0;
  transform: translateY(6px);
  animation: fadeSlideUp 0.3s ease-out forwards;
  animation-delay: 0.34s;
}


/* –∞–Ω–∏–º–∞—Ü–∏–∏ */
@keyframes fadeSlideDown {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes fadeSlideUp {
  from {
    opacity: 0;
    transform: translateY(8px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body>
  <div id="authOverlay" style="
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.85);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 5000;
  backdrop-filter: blur(10px);
">
  <div style="
    background: rgba(8,12,20,0.96);
    border-radius: 20px;
    padding: 2rem 2.5rem;
    border: 1px solid rgba(255,255,255,0.18);
    box-shadow: 0 20px 60px rgba(0,0,0,0.9);
    min-width: 300px;
    max-width: 360px;
  ">
    <div style="font-size:1.4rem; margin-bottom:1rem;">–í—Ö–æ–¥ –≤ –∫–ª–∞–Ω‚Äë–ø–æ—Ä—Ç–∞–ª</div>
    <div style="font-size:0.85rem; opacity:0.8; margin-bottom:1rem;">
      –î–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–≤–æ–∏—Ö.
    </div>

    <input
      type="text"
      id="authLogin"
      placeholder="–õ–æ–≥–∏–Ω"
      style="
        width:100%;
        padding:0.8rem 1rem;
        border-radius:10px;
        border:1px solid rgba(255,255,255,0.25);
        background: rgba(0,0,0,0.85);
        color:#e0e0e0;
        margin-bottom:0.6rem;
        outline:none;
      "
      onkeydown="if(event.key==='Enter'){document.getElementById('authPassword').focus();}"
    >

    <input
      type="password"
      id="authPassword"
      placeholder="–ü–∞—Ä–æ–ª—å"
      style="
        width:100%;
        padding:0.8rem 1rem;
        border-radius:10px;
        border:1px solid rgba(255,255,255,0.25);
        background: rgba(0,0,0,0.85);
        color:#e0e0e0;
        margin-bottom:0.8rem;
        outline:none;
      "
      onkeydown="if(event.key==='Enter'){submitAuth();}"
    >

    <button
      onclick="submitAuth()"
      style="
        width:100%;
        padding:0.8rem 1rem;
        border-radius:10px;
        border:none;
        cursor:pointer;
        background:#4ecdc4;
        color:#000;
        font-weight:600;
      "
    >–í–æ–π—Ç–∏</button>

    <div id="authError" style="margin-top:0.6rem; font-size:0.8rem; color:#ff6b6b; display:none;">
      –ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å
    </div>
  </div>
</div>
  <div class="container">
    <div class="glass-card clan-header">
      <div class="clan-title">–ü–∞—Ä–ª–∞–º–µ–Ω—Ç</div>
      <div style="font-size:1.2rem; opacity:0.9; margin-bottom:1.5rem;">–õ–∏–¥–µ—Ä: <strong>Roter_Morder</strong></div>
      <div class="clan-stats">
        <div class="stat-item"><div class="stat-value" id="clanPlayersCount">0</div><div class="stat-label">–ò–≥—Ä–æ–∫–æ–≤</div></div>
        <div class="stat-item"><div class="stat-value">#242</div><div class="stat-label">–†–µ–π—Ç–∏–Ω–≥</div></div>
        <div class="stat-item"><div class="stat-value">D</div><div class="stat-label">–†–∞–Ω–≥</div></div>
      </div>
    </div>

<div class="tab-buttons">
  <button class="tab-btn active" data-tab="squad">üë• –°–æ—Å—Ç–∞–≤</button>
  <button class="tab-btn" data-tab="squads">üè∑Ô∏è –û—Ç—Ä—è–¥—ã</button>
  <button class="tab-btn" data-tab="grenades">üí£ –ì—Ä–∞–Ω–∞—Ç—ã</button>
  <button class="tab-btn" data-tab="maps">üó∫Ô∏è –ö–∞—Ä—Ç—ã</button>
  <button class="tab-btn" data-tab="stats">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
  <button class="tab-btn" data-tab="history">üìà –ò—Å—Ç–æ—Ä–∏—è</button>
</div>


    <div id="squad" class="glass-card tab-content active">
      <div class="squad-filter">
        <div style="display:flex; gap:1rem; flex-wrap:wrap;">
          <select id="squadSelect" class="squad-select" onchange="filterSquad()">
            <option value="all">–í—Å–µ –æ—Ç—Ä—è–¥—ã</option>
            <option value="1">1 –æ—Ç—Ä—è–¥</option>
            <option value="2">2 –æ—Ç—Ä—è–¥</option>
            <option value="3">3 –æ—Ç—Ä—è–¥</option>
            <option value="4">4 –æ—Ç—Ä—è–¥</option>
            <option value="5">5 –æ—Ç—Ä—è–¥</option>
            <option value="ralik">–†–∞–ª–∏–∫</option>
            <option value="reserve">–ó–∞–ø–∞—Å</option>
            <option value="reserve_out">–ó–∞–ø–∞—Å –≤–Ω–µ –∫–ª–∞–Ω–∞</option>
          </select>
          <input type="text" id="playerSearch" class="player-search" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∏–∫—É..." oninput="filterPlayers()">
          <button id="addPlayerBtn" style="padding:1rem 1.5rem; border-radius:12px; border:none; cursor:pointer; background:#4ecdc4; color:#000; font-weight:600;" onclick="openAddPlayerModal()">+ –î–æ–±–∞–≤–∏—Ç—å –∏–≥—Ä–æ–∫–∞</button>
        </div>
        <div class="login-info" id="loginInfo">
          –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ (–ª–æ–∫–∞–ª—å–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è)
        </div>
      </div>
      <div id="playersGrid" class="players-grid"></div>
    </div>

<div id="squads" class="glass-card tab-content">
  <h3 style="margin-bottom: 1.5rem; color: #fff;">üè∑Ô∏è –û—Ç—Ä—è–¥—ã</h3>
  <div class="squads-grid">
    <div class="squad-column">
      <div class="squad-column-title">1 –æ—Ç—Ä—è–¥</div>
      <div class="squad-column-body" id="squad-col-1"></div>
    </div>
    <div class="squad-column">
      <div class="squad-column-title">2 –æ—Ç—Ä—è–¥</div>
      <div class="squad-column-body" id="squad-col-2"></div>
    </div>
    <div class="squad-column">
      <div class="squad-column-title">3 –æ—Ç—Ä—è–¥</div>
      <div class="squad-column-body" id="squad-col-3"></div>
    </div>
    <div class="squad-column">
      <div class="squad-column-title">4 –æ—Ç—Ä—è–¥</div>
      <div class="squad-column-body" id="squad-col-4"></div>
    </div>
    <div class="squad-column">
      <div class="squad-column-title">5 –æ—Ç—Ä—è–¥</div>
      <div class="squad-column-body" id="squad-col-5"></div>
    </div>
    <div class="squad-column">
      <div class="squad-column-title">–†–∞–ª–∏–∫</div>
      <div class="squad-column-body" id="squad-col-ralik"></div>
    </div>
  <div class="squads-extra">
    <div class="squads-sub-block">
      <div class="squad-column-title">–ó–∞–º–µ–Ω–∞</div>
      <div class="squad-column-body" id="squad-col-reserve-out"></div>
    </div>
  </div>

  <div class="squads-notes-wrap">
    <div class="squad-column-title">–ó–∞–º–µ—Ç–∫–∏</div>
    <div
      id="squads-notes"
      class="squads-notes"
      contenteditable="true"
      placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –±–ª–∞ –±–ª–∞, –ª—è –ª—è, –∫—Ç–æ –∑–∞ –∫–æ–≥–æ –º–µ–Ω—è–µ—Ç—Å—è..."
    ></div>
    <div class="squads-notes-hint">
      –¢–µ–∫—Å—Ç —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ.
    </div>
  </div>

  <div style="font-size:0.8rem; opacity:0.7; margin-top:0.75rem;">
    –°–ø–∏—Å–æ–∫ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –∏–∑ –≤–∫–ª–∞–¥–∫–∏ ¬´–°–æ—Å—Ç–∞–≤¬ª (–ø–æ–ª–µ ¬´–û—Ç—Ä—è–¥¬ª —É –∏–≥—Ä–æ–∫–∞).
  </div>

</div>
</div>
    <div id="playerModal" class="player-modal">
      <div class="modal-close" onclick="closePlayerModal()">‚úï</div>
      <div id="modalContent"></div>
      <div style="margin-top:1.5rem; display:flex; justify-content:space-between; gap:1rem;">
        <button id="savePlayerBtn" style="flex:1; padding:0.8rem 1rem; border-radius:12px; border:none; cursor:pointer; background:#4ecdc4; color:#000; font-weight:600;" onclick="savePlayerFromModal()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button id="deletePlayerBtn" style="flex:1; padding:0.8rem 1rem; border-radius:12px; border:none; cursor:pointer; background:#ff6b6b; color:#000; font-weight:600;" onclick="deletePlayerFromModal()">–£–¥–∞–ª–∏—Ç—å</button>
      </div>
    </div>

    <div id="grenades" class="glass-card tab-content">
      <div style="min-height:320px; display:flex; align-items:center; justify-content:center;">
        <div style="padding:2.5rem 3rem; border-radius:24px; border:2px dashed rgba(255,80,80,0.7); background:rgba(10,10,10,0.85); backdrop-filter:blur(22px); box-shadow:0 18px 50px rgba(0,0,0,0.8); text-align:center;">
          <div style="font-size:1.8rem; color:#ff6868; margin-bottom:0.75rem; letter-spacing:1px;">
            –í –†–ê–ó–†–ê–ë–û–¢–ö–ï
          </div>
          <div style="font-size:0.95rem; opacity:0.8; max-width:420px;">
            –†–∞–∑–¥–µ–ª —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ –≥—Ä–∞–Ω–∞—Ç–∞–º –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ.
            –°–∫–æ—Ä–æ –∑–¥–µ—Å—å –ø–æ—è–≤—è—Ç—Å—è —Ç–∞–±–ª–∏—Ü—ã –∏ –≥—Ä–∞—Ñ–∏–∫–∏ –ø–æ —ç—Ç–∞–ø–∞–º –∏ –Ω–µ–¥–µ–ª—è–º.
          </div>
        </div>
      </div>
    </div>

    <div id="maps" class="glass-card tab-content">
      <h3 style="margin-bottom: 2rem; color: #fff;">üó∫Ô∏è –ö–∞—Ä—Ç—ã</h3>
      <div class="maps-grid">
        <div class="map-card" onclick="openMapModal('Hvoynik', 'Hvoynik.png')">
          <img src="/maps/Hvoynik.png" alt="Hvoynik">
          <div class="map-card-title">Hvoynik</div>
        </div>
        <div class="map-card" onclick="openMapModal('Hvoynik reverse', 'Hvoynik_reverse.png')">
          <img src="/maps/Hvoynik_reverse.png" alt="Hvoynik reverse">
          <div class="map-card-title">Hvoynik reverse</div>
        </div>
        <div class="map-card" onclick="openMapModal('Berda', 'Berda.png')">
          <img src="/maps/Berda.png" alt="Berda">
          <div class="map-card-title">Berda</div>
        </div>
        <div class="map-card" onclick="openMapModal('Berda reverse', 'Berda_reverse.png')">
          <img src="/maps/Berda_reverse.png" alt="Berda reverse">
          <div class="map-card-title">Berda reverse</div>
        </div>
        <div class="map-card" onclick="openMapModal('Nizina', 'Nizina.png')">
          <img src="/maps/Nizina.png" alt="Nizina">
          <div class="map-card-title">Nizina</div>
        </div>
        <div class="map-card" onclick="openMapModal('Nizina reverse', 'Nizina_reverse.png')">
          <img src="/maps/Nizina_reverse.png" alt="Nizina reverse">
          <div class="map-card-title">Nizina reverse</div>
        </div>
        <div class="map-card" onclick="openMapModal('Zaton', 'Zaton.png')">
          <img src="/maps/Zaton.png" alt="Zaton">
          <div class="map-card-title">Zaton</div>
        </div>
      </div>
    </div>

<div id="stats" class="glass-card tab-content">
  <h3 style="margin-bottom: 2rem; color: #fff;">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–ª–∞–Ω–∞</h3>

  <div style="display:grid; grid-template-columns:1fr 1fr; gap:2rem;">

    <div>
      <div style="font-size:0.9rem; opacity:0.8; margin-bottom:0.3rem;">–ì–∏–ª—å–∑—ã –∑–∞ –¥–µ–Ω—å</div>
      <div id="stat-shells-day" class="stat-edit-big" contenteditable="true">0</div>
    </div>

    <div>
      <div style="font-size:0.9rem; opacity:0.8; margin-bottom:0.3rem;">–ì–∏–ª—å–∑—ã –∑–∞ –Ω–µ–¥–µ–ª—é</div>
      <div id="stat-shells-week" class="stat-edit-big" contenteditable="true">0</div>
    </div>

    <div>
      <div style="font-size:0.9rem; opacity:0.8; margin-bottom:0.3rem;">+ –†–µ–π—Ç–∏–Ω–≥ –∑–∞ –¥–µ–Ω—å</div>
      <div id="stat-rating-plus-day" class="stat-edit-big stat-positive" contenteditable="true">0</div>
    </div>

    <div>
      <div style="font-size:0.9rem; opacity:0.8; margin-bottom:0.3rem;">+ –†–µ–π—Ç–∏–Ω–≥ –∑–∞ –Ω–µ–¥–µ–ª—é</div>
      <div id="stat-rating-plus-week" class="stat-edit-big stat-positive" contenteditable="true">0</div>
    </div>

    <div>
      <div style="font-size:0.9rem; opacity:0.8; margin-bottom:0.3rem;">‚àí –†–µ–π—Ç–∏–Ω–≥ –∑–∞ –¥–µ–Ω—å</div>
      <div id="stat-rating-minus-day" class="stat-edit-big stat-negative" contenteditable="true">0</div>
    </div>

    <div>
      <div style="font-size:0.9rem; opacity:0.8; margin-bottom:0.3rem;">‚àí –†–µ–π—Ç–∏–Ω–≥ –∑–∞ –Ω–µ–¥–µ–ª—é</div>
      <div id="stat-rating-minus-week" class="stat-edit-big stat-negative" contenteditable="true">0</div>
    </div>

  </div>
  <div style="font-size:0.8rem; opacity:0.65; margin-top:0.75rem;">
    –¶–∏—Ñ—Ä—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä—É—é—Ç—Å—è –≤—Ä—É—á–Ω—É—é, —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ.
  </div>
</div>


<div id="history" class="glass-card tab-content">
  <div style="min-height:320px; display:flex; align-items:center; justify-content:center;">
    <div style="padding:2.5rem 3rem; border-radius:24px; border:2px dashed rgba(255,80,80,0.7); background:rgba(10,10,10,0.85); backdrop-filter:blur(22px); box-shadow:0 18px 50px rgba(0,0,0,0.8); text-align:center;">
      <div style="font-size:1.8rem; color:#ff6868; margin-bottom:0.75rem; letter-spacing:1px;">
        –í –†–ê–ó–†–ê–ë–û–¢–ö–ï
      </div>
      <div style="font-size:0.95rem; opacity:0.8; max-width:420px;">
        –†–∞–∑–¥–µ–ª –∏—Å—Ç–æ—Ä–∏–∏ —ç—Ç–∞–ø–æ–≤ KV –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ.
        –°–∫–æ—Ä–æ –∑–¥–µ—Å—å –±—É–¥—É—Ç —Ç–∞–±–ª–∏—Ü—ã –∏ –≥—Ä–∞—Ñ–∏–∫–∏ –ø–æ —ç—Ç–∞–ø–∞–º.
      </div>
    </div>
  </div>
</div>

  </div>

  <div id="mapModalBackdrop" class="map-modal-backdrop">
<div class="map-modal">
  <div class="map-modal-header">
    <div class="map-modal-title" id="mapModalTitle">–ö–∞—Ä—Ç–∞</div>
    <div class="map-modal-close" onclick="closeMapModal()">‚úï</div>
  </div>

  <div class="map-modal-body">
    <div class="map-canvas-wrap" id="mapCanvasWrapper">
      <div id="mapScrollContainer" style="width:100%; height:100%; overflow:auto;">
        <canvas id="mapCanvas"></canvas>
      </div>
    </div>

    <div class="map-sidebar">
      <div class="map-color-block">
        <div class="map-color-label">–¶–≤–µ—Ç –∫–∏—Å—Ç–∏/—Ñ–∏–≥—É—Ä</div>
        <input type="color" id="toolColor" value="#ff4444">
      </div>

      <div class="map-sidebar-section">
        <label class="map-sidebar-label">
          –¢–æ–ª—â–∏–Ω–∞
          <input type="number" id="toolWidth" value="3" min="1" max="40">
        </label>
      </div>

      <div class="map-sidebar-section">
        <div class="map-sidebar-label" style="margin-bottom:0.4rem;">–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</div>
        <div class="map-tools-vertical">
          <button class="tool-btn" id="toolSelect" onclick="setTool('select')">–°—Ç—Ä–µ–ª–∫–∞</button>
          <button class="tool-btn" id="toolBrush" onclick="setTool('brush')">–ö–∏—Å—Ç—å</button>
          <button class="tool-btn" id="toolRect" onclick="setTool('rect')">–ü—Ä—è–º–æ—É–≥.</button>
          <button class="tool-btn" id="toolCircle" onclick="setTool('circle')">–ö—Ä—É–≥</button>
          <button class="tool-btn" id="toolTriangle" onclick="setTool('triangle')">–¢—Ä–µ—É–≥.</button>
          <button class="tool-btn" id="toolText" onclick="setTool('text')">–¢–µ–∫—Å—Ç</button>
        </div>
      </div>
    </div>
  </div>
</div>


    </div>
  </div>

  <script>
    const defaultPlayers = [
      {
        id: 1,
        name: 'Player1',
        rank: '–õ–∏–¥–µ—Ä',
        squad: '1',
        gear: {
          weapon: 'AK-74',
          secondary: 'Makarov',
          armor: 'Beryl',
          armor2: 'Exolight',
          build1: '–°–±–æ—Ä–∫–∞ 1',
          build2: '–°–±–æ—Ä–∫–∞ 2'
        },
        builds: {
          build1Url: '',
          build2Url: ''
        },
        stats: '–ì–ª–∞–≤–Ω—ã–π –∫–æ–º–∞–Ω–¥–∏—Ä, –æ—Å–Ω–æ–≤–Ω–æ–π —à—Ç—É—Ä–º–æ–≤–∏–∫.'
      },
      {
        id: 2,
        name: 'Player2',
        rank: '–ë–æ–µ—Ü',
        squad: '2',
        gear: {
          weapon: 'Groza',
          secondary: 'P226',
          armor: '–°—Ç–∞–ª—å–Ω–æ–π',
          armor2: '-',
          build1: '–†–∞–¥–∏–∞—Ü–∏—è',
          build2: '-'
        },
        builds: {
          build1Url: '',
          build2Url: ''
        },
        stats: '–ë–æ–µ—Ü –ø–æ–¥–¥–µ—Ä–∂–∫–∏, –±–µ–≥–∞–µ—Ç –ø–æ –∫–≤–µ—Å—Ç–∞–º.'
      }
    ];

    let allPlayers = [...defaultPlayers];
    let currentSquad = 'all';
    let canEdit = true;
    let editingPlayerId = null;

    async function loadPlayersFromServer() {
      try {
        const res = await fetch('/api/players');
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();
        if (Array.isArray(data) && data.length > 0) {
          allPlayers = data;
          return true;
        }
        return false;
      } catch (e) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ /api/players', e);
        return false;
      }
    }

    async function savePlayersToServer() {
      try {
        const res = await fetch('/api/players', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(allPlayers)
        });
        if (!res.ok) {
          console.error('–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏', res.status);
        }
      } catch (e) {
        console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è /api/players', e);
      }
    }

document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.onclick = function() {
    const tabName = this.dataset.tab;
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(tabName).classList.add('active');
    this.classList.add('active');

    if (tabName === 'squad') {
      renderPlayers(getFilteredPlayers());
    } else if (tabName === 'squads') {
      renderSquadsBoard();
    }
  };
});


    function rankOrder(rank) {
      switch (rank) {
        case '–õ–∏–¥–µ—Ä': return 1;
        case '–ü–æ–ª–∫–æ–≤–Ω–∏–∫': return 2;
        case '–û—Ñ–∏—Ü–µ—Ä': return 3;
        case '–ë–æ–µ—Ü': return 4;
        case '–ó–∞–ø–∞—Å': return 5;
        default: return 999;
      }
    }

    function getFilteredPlayers() {
      const search = document.getElementById('playerSearch').value.toLowerCase();
      return allPlayers.filter(p =>
        p.name.toLowerCase().includes(search) &&
        (currentSquad === 'all' || p.squad === currentSquad)
      );
    }

    function formatSquad(s) {
      switch (s) {
        case '1': return '1';
        case '2': return '2';
        case '3': return '3';
        case '4': return '4';
        case '5': return '5';
        case 'ralik': return '–†–∞–ª–∏–∫';
        case 'reserve': return '–ó–∞–ø–∞—Å';
        case 'reserve_out': return '–ó–∞–ø–∞—Å –≤–Ω–µ –∫–ª–∞–Ω–∞';
        default: return s;
      }
    }

    function enableBuildPreviews() {
      document.querySelectorAll('.build-item').forEach(el => {
        const playerId = Number(el.getAttribute('data-player-id'));
        const buildKey = el.getAttribute('data-build');
        const player = allPlayers.find(p => p.id === playerId);
        if (!player) return;
        const urlKey = buildKey === 'build1' ? 'build1Url' : 'build2Url';
        const url = player.builds && player.builds[urlKey];

        const preview = el.querySelector('.build-preview');
        const img = preview.querySelector('img');

        if (url) {
          img.src = url;
          el.onmouseenter = () => { preview.style.display = 'block'; };
          el.onmouseleave = () => { preview.style.display = 'none'; };
          el.onclick = (e) => {
            e.stopPropagation();
            window.open(url, '_blank');
          };
        } else {
          el.onmouseenter = null;
          el.onmouseleave = null;
          el.onclick = null;
          preview.style.display = 'none';
        }
      });
    }

    function renderPlayers(players) {
      const grid = document.getElementById('playersGrid');
      grid.innerHTML = '';

      const sorted = [...players].sort((a, b) => {
        const rA = rankOrder(a.rank);
        const rB = rankOrder(b.rank);
        if (rA !== rB) return rA - rB;
        return a.name.localeCompare(b.name);
      });

      sorted.forEach(p => {
        const card = document.createElement('div');
        card.className = 'player-card';
        card.onclick = (e) => { e.stopPropagation(); openPlayerModal(p); };
        card.innerHTML = `
          <div class="player-name">${p.name}</div>
          <div class="player-rank">${p.rank} | –û—Ç—Ä—è–¥ ${formatSquad(p.squad)}</div>
          <div class="player-gear">
            <div class="gear-item">
              <div class="gear-label">–û—Ä—É–∂–∏–µ</div>
              <div class="gear-value">${p.gear.weapon}</div>
            </div>
            <div class="gear-item">
              <div class="gear-label">–í—Ç–æ—Ä–∏—á–∫–∞</div>
              <div class="gear-value">${p.gear.secondary}</div>
            </div>
            <div class="gear-item">
              <div class="gear-label">–ë—Ä–æ–Ω–∏–∫</div>
              <div class="gear-value">${p.gear.armor}</div>
            </div>
            <div class="gear-item">
              <div class="gear-label">–í—Ç–æ—Ä.–±—Ä–æ–Ω–∏–∫</div>
              <div class="gear-value">${p.gear.armor2}</div>
            </div>
            <div class="gear-item build-item" data-build="build1" data-player-id="${p.id}">
              <div class="gear-label">–°–±–æ—Ä–∫–∞ 1</div>
              <div class="gear-value">${p.gear.build1 || '-'}</div>
              <div class="build-preview"><img></div>
            </div>
            <div class="gear-item build-item" data-build="build2" data-player-id="${p.id}">
              <div class="gear-label">–°–±–æ—Ä–∫–∞ 2</div>
              <div class="gear-value">${p.gear.build2 || '-'}</div>
              <div class="build-preview"><img></div>
            </div>
          </div>
        `;
        grid.appendChild(card);
      });

      document.getElementById('clanPlayersCount').textContent = allPlayers.length.toString();
      enableBuildPreviews();
    }
function renderSquadsBoard() {
  const map = {
    1: document.getElementById('squad-col-1'),
    2: document.getElementById('squad-col-2'),
    3: document.getElementById('squad-col-3'),
    4: document.getElementById('squad-col-4'),
    5: document.getElementById('squad-col-5'),
    ralik: document.getElementById('squad-col-ralik'),
    reserve: document.getElementById('squad-col-reserve-out'),
    reserveout: document.getElementById('squad-col-reserve-out')
  };

  Object.values(map).forEach(col => {
    if (col) col.innerHTML = '';
  });

  const bySquad = {};
  allPlayers.forEach(p => {
    const s = p.squad || '1';
    if (!bySquad[s]) bySquad[s] = [];
    bySquad[s].push(p);
  });

  Object.keys(bySquad).forEach(s => {
    const col = map[s];
    if (!col) return;
    const list = bySquad[s].sort((a, b) => a.name.localeCompare(b.name));
    list.forEach(p => {
      const div = document.createElement('div');
      div.className = 'squad-pill';
      div.textContent = p.name;
      div.dataset.playerId = String(p.id);

      div.onclick = () => {
        const player = allPlayers.find(x => x.id === p.id);
        if (!player) return;

        // –≤–∫–ª—é—á–∞–µ–º –≤–∫–ª–∞–¥–∫—É "–°–æ—Å—Ç–∞–≤"
        document.querySelectorAll('.tab-btn').forEach(b => {
          b.classList.toggle('active', b.dataset.tab === 'squad');
        });
        document.querySelectorAll('.tab-content').forEach(c => {
          c.classList.toggle('active', c.id === 'squad');
        });

        // –ø–µ—Ä–µ—Ä–µ–Ω–¥–µ—Ä –∏ –æ—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏
        renderPlayers(getFilteredPlayers());
        openPlayerModal(player);
      };

      col.appendChild(div);
    });
  });

  loadSquadsNotes();
}


// ===== –ó–∞–º–µ—Ç–∫–∏ –ø–æ –æ—Ç—Ä—è–¥–∞–º (localStorage) =====

const SQUADS_NOTES_KEY = 'clan_squads_notes_v1';

function loadSquadsNotes() {
  const el = document.getElementById('squads-notes');
  if (!el) return;

  if (!el.dataset.init) {
    el.dataset.init = '1';
    el.addEventListener('blur', saveSquadsNotes);
    el.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
        e.preventDefault();
        el.blur();
      }
    });
  }

  try {
    const saved = localStorage.getItem(SQUADS_NOTES_KEY);
    if (saved !== null) {
      el.textContent = saved;
    }
  } catch (e) {
    console.error('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –∑–∞–º–µ—Ç–æ–∫ –ø–æ –æ—Ç—Ä—è–¥–∞–º', e);
  }
}

function saveSquadsNotes() {
  const el = document.getElementById('squads-notes');
  if (!el) return;
  const text = el.textContent.trim();
  try {
    localStorage.setItem(SQUADS_NOTES_KEY, text);
  } catch (e) {
    console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–∞–º–µ—Ç–æ–∫ –ø–æ –æ—Ç—Ä—è–¥–∞–º', e);
  }
}

    function openPlayerModal(player) {
      editingPlayerId = player.id;
      document.getElementById('modalContent').innerHTML = `
        <div style="display:flex; flex-direction:column; gap:1rem; padding-top:1.5rem;">
          <div>
            <label>–ù–∏–∫:</label>
            <input id="modalName" type="text" value="${player.name}" class="gear-item-input" style="margin-top:0.3rem;">
          </div>
          <div>
            <label>–†–∞–Ω–≥:</label>
            <select id="modalRank" class="gear-item-input" style="margin-top:0.3rem;">
              <option value="–õ–∏–¥–µ—Ä" ${player.rank === '–õ–∏–¥–µ—Ä' ? 'selected' : ''}>–õ–∏–¥–µ—Ä</option>
              <option value="–ü–æ–ª–∫–æ–≤–Ω–∏–∫" ${player.rank === '–ü–æ–ª–∫–æ–≤–Ω–∏–∫' ? 'selected' : ''}>–ü–æ–ª–∫–æ–≤–Ω–∏–∫</option>
              <option value="–û—Ñ–∏—Ü–µ—Ä" ${player.rank === '–û—Ñ–∏—Ü–µ—Ä' ? 'selected' : ''}>–û—Ñ–∏—Ü–µ—Ä</option>
              <option value="–ë–æ–µ—Ü" ${player.rank === '–ë–æ–µ—Ü' ? 'selected' : ''}>–ë–æ–µ—Ü</option>
              <option value="–ó–∞–ø–∞—Å" ${player.rank === '–ó–∞–ø–∞—Å' ? 'selected' : ''}>–ó–∞–ø–∞—Å</option>
            </select>
          </div>
          <div>
            <label>–û—Ç—Ä—è–¥:</label>
            <select id="modalSquad" class="gear-item-input" style="margin-top:0.3rem;">
              <option value="1" ${player.squad === '1' ? 'selected' : ''}>1 –æ—Ç—Ä—è–¥</option>
              <option value="2" ${player.squad === '2' ? 'selected' : ''}>2 –æ—Ç—Ä—è–¥</option>
              <option value="3" ${player.squad === '3' ? 'selected' : ''}>3 –æ—Ç—Ä—è–¥</option>
              <option value="4" ${player.squad === '4' ? 'selected' : ''}>4 –æ—Ç—Ä—è–¥</option>
              <option value="5" ${player.squad === '5' ? 'selected' : ''}>5 –æ—Ç—Ä—è–¥</option>
              <option value="ralik" ${player.squad === 'ralik' ? 'selected' : ''}>–†–∞–ª–∏–∫</option>
              <option value="reserve" ${player.squad === 'reserve' ? 'selected' : ''}>–ó–∞–ø–∞—Å</option>
              <option value="reserve_out" ${player.squad === 'reserve_out' ? 'selected' : ''}>–ó–∞–ø–∞—Å –≤–Ω–µ –∫–ª–∞–Ω–∞</option>
            </select>
          </div>
          <div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:1.5rem;">
            <div>
              <label>üî´ –û—Ä—É–∂–∏–µ:</label>
              <input id="modalWeapon" type="text" value="${player.gear.weapon}" class="gear-item-input" style="margin-top:0.3rem;">
            </div>
            <div>
              <label>üî´ –í—Ç–æ—Ä–∏—á–∫–∞:</label>
              <input id="modalSecondary" type="text" value="${player.gear.secondary}" class="gear-item-input" style="margin-top:0.3rem;">
            </div>
            <div>
              <label>üõ°Ô∏è –ë—Ä–æ–Ω–∏–∫:</label>
              <input id="modalArmor" type="text" value="${player.gear.armor}" class="gear-item-input" style="margin-top:0.3rem;">
            </div>
            <div>
              <label>üõ°Ô∏è –í—Ç–æ—Ä.–±—Ä–æ–Ω–∏–∫:</label>
              <input id="modalArmor2" type="text" value="${player.gear.armor2}" class="gear-item-input" style="margin-top:0.3rem;">
            </div>
            <div>
              <label>‚öôÔ∏è –°–±–æ—Ä–∫–∞ 1 (–Ω–∞–∑–≤–∞–Ω–∏–µ):</label>
              <input id="modalBuild1" type="text" value="${player.gear.build1 || ''}" class="gear-item-input" style="margin-top:0.3rem;">
            </div>
            <div>
              <label>‚öôÔ∏è –°–±–æ—Ä–∫–∞ 2 (–Ω–∞–∑–≤–∞–Ω–∏–µ):</label>
              <input id="modalBuild2" type="text" value="${player.gear.build2 || ''}" class="gear-item-input" style="margin-top:0.3rem;">
            </div>
            <div>
              <label>URL —Å–±–æ—Ä–∫–∏ 1 (–∫–∞—Ä—Ç–∏–Ω–∫–∞):</label>
              <input id="modalBuild1Url" type="text" value="${(player.builds && player.builds.build1Url) || ''}" class="gear-item-input" style="margin-top:0.3rem;">
            </div>
            <div>
              <label>URL —Å–±–æ—Ä–∫–∏ 2 (–∫–∞—Ä—Ç–∏–Ω–∫–∞):</label>
              <input id="modalBuild2Url" type="text" value="${(player.builds && player.builds.build2Url) || ''}" class="gear-item-input" style="margin-top:0.3rem;">
            </div>
          </div>
          <div>
            <label>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–≥—Ä–æ–∫–∞:</label>
            <textarea id="modalStats" class="gear-item-input" style="margin-top:0.3rem; min-height:80px; resize:vertical;">${player.stats || ''}</textarea>
          </div>
        </div>
      `;
      document.getElementById('playerModal').classList.add('active');
      document.getElementById('deletePlayerBtn').style.display = 'inline-block';
    }

    function openAddPlayerModal() {
      if (!canEdit) return;
      editingPlayerId = null;
      document.getElementById('modalContent').innerHTML = `
        <div style="display:flex; flex-direction:column; gap:1rem; padding-top:1.5rem;">
          <div>
            <label>–ù–∏–∫:</label>
            <input id="modalName" type="text" value="" class="gear-item-input" style="margin-top:0.3rem;">
          </div>
          <div>
            <label>–†–∞–Ω–≥:</label>
            <select id="modalRank" class="gear-item-input" style="margin-top:0.3rem;">
              <option value="–õ–∏–¥–µ—Ä">–õ–∏–¥–µ—Ä</option>
              <option value="–ü–æ–ª–∫–æ–≤–Ω–∏–∫">–ü–æ–ª–∫–æ–≤–Ω–∏–∫</option>
              <option value="–û—Ñ–∏—Ü–µ—Ä">–û—Ñ–∏—Ü–µ—Ä</option>
              <option value="–ë–æ–µ—Ü" selected>–ë–æ–µ—Ü</option>
              <option value="–ó–∞–ø–∞—Å">–ó–∞–ø–∞—Å</option>
            </select>
          </div>
          <div>
            <label>–û—Ç—Ä—è–¥:</label>
            <select id="modalSquad" class="gear-item-input" style="margin-top:0.3rem;">
              <option value="1">1 –æ—Ç—Ä—è–¥</option>
              <option value="2">2 –æ—Ç—Ä—è–¥</option>
              <option value="3">3 –æ—Ç—Ä—è–¥</option>
              <option value="4">4 –æ—Ç—Ä—è–¥</option>
              <option value="5">5 –æ—Ç—Ä—è–¥</option>
              <option value="ralik">–†–∞–ª–∏–∫</option>
              <option value="reserve">–ó–∞–ø–∞—Å</option>
              <option value="reserve_out">–ó–∞–ø–∞—Å –≤–Ω–µ –∫–ª–∞–Ω–∞</option>
            </select>
          </div>
          <div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:1.5rem;">
            <div>
              <label>üî´ –û—Ä—É–∂–∏–µ:</label>
              <input id="modalWeapon" type="text" value="" class="gear-item-input" style="margin-top:0.3rem;">
            </div>
            <div>
              <label>üî´ –í—Ç–æ—Ä–∏—á–∫–∞:</label>
              <input id="modalSecondary" type="text" value="" class="gear-item-input" style="margin-top:0.3rem;">
            </div>
            <div>
              <label>üõ°Ô∏è –ë—Ä–æ–Ω–∏–∫:</label>
              <input id="modalArmor" type="text" value="" class="gear-item-input" style="margin-top:0.3rem;">
            </div>
            <div>
              <label>üõ°Ô∏è –í—Ç–æ—Ä.–±—Ä–æ–Ω–∏–∫:</label>
              <input id="modalArmor2" type="text" value="" class="gear-item-input" style="margin-top:0.3rem;">
            </div>
            <div>
              <label>‚öôÔ∏è –°–±–æ—Ä–∫–∞ 1 (–Ω–∞–∑–≤–∞–Ω–∏–µ):</label>
              <input id="modalBuild1" type="text" value="" class="gear-item-input" style="margin-top:0.3rem;">
            </div>
            <div>
              <label>‚öôÔ∏è –°–±–æ—Ä–∫–∞ 2 (–Ω–∞–∑–≤–∞–Ω–∏–µ):</label>
              <input id="modalBuild2" type="text" value="" class="gear-item-input" style="margin-top:0.3rem;">
            </div>
            <div>
              <label>URL —Å–±–æ—Ä–∫–∏ 1 (–∫–∞—Ä—Ç–∏–Ω–∫–∞):</label>
              <input id="modalBuild1Url" type="text" value="" class="gear-item-input" style="margin-top:0.3rem;">
            </div>
            <div>
              <label>URL —Å–±–æ—Ä–∫–∏ 2 (–∫–∞—Ä—Ç–∏–Ω–∫–∞):</label>
              <input id="modalBuild2Url" type="text" value="" class="gear-item-input" style="margin-top:0.3rem;">
            </div>
          </div>
          <div>
            <label>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–≥—Ä–æ–∫–∞:</label>
            <textarea id="modalStats" class="gear-item-input" style="margin-top:0.3rem; min-height:80px; resize:vertical;"></textarea>
          </div>
        </div>
      `;
      document.getElementById('playerModal').classList.add('active');
      document.getElementById('deletePlayerBtn').style.display = 'none';
    }

    function savePlayerFromModal() {
      if (!canEdit) return;

      const name = document.getElementById('modalName').value.trim() || '–ë–µ–∑—ã–º—è–Ω–Ω—ã–π';
      const rank = document.getElementById('modalRank').value;
      const squad = document.getElementById('modalSquad').value;
      const weapon = document.getElementById('modalWeapon').value.trim() || '-';
      const secondary = document.getElementById('modalSecondary').value.trim() || '-';
      const armor = document.getElementById('modalArmor').value.trim() || '-';
      const armor2 = document.getElementById('modalArmor2').value.trim() || '-';
      const build1 = document.getElementById('modalBuild1').value.trim() || '-';
      const build2 = document.getElementById('modalBuild2').value.trim() || '-';
      const build1Url = document.getElementById('modalBuild1Url').value.trim();
      const build2Url = document.getElementById('modalBuild2Url').value.trim();
      const stats = document.getElementById('modalStats').value.trim();

      if (squad !== 'reserve_out') {
        const countInSquad = allPlayers.filter(p => p.squad === squad && p.id !== editingPlayerId).length;
        if (countInSquad >= 6) {
          alert('–í —ç—Ç–æ–º –æ—Ç—Ä—è–¥–µ —É–∂–µ 6 –∏–≥—Ä–æ–∫–æ–≤. –£–¥–∞–ª–∏ –∫–æ–≥–æ-—Ç–æ –∏–ª–∏ –≤—ã–±–µ—Ä–∏ –¥—Ä—É–≥–æ–π –æ—Ç—Ä—è–¥.');
          return;
        }
      }

      const isNew = (editingPlayerId === null);
      if (isNew && allPlayers.length >= 40) {
        alert('–î–æ—Å—Ç–∏–≥–Ω—É—Ç –æ–±—â–∏–π –ª–∏–º–∏—Ç 40 –∏–≥—Ä–æ–∫–æ–≤.');
        return;
      }

      if (editingPlayerId === null) {
        const newId = allPlayers.length ? Math.max(...allPlayers.map(p => p.id)) + 1 : 1;
        allPlayers.push({
          id: newId,
          name,
          rank,
          squad,
          gear: { weapon, secondary, armor, armor2, build1, build2 },
          builds: { build1Url, build2Url },
          stats
        });
      } else {
        const player = allPlayers.find(p => p.id === editingPlayerId);
        if (player) {
          player.name = name;
          player.rank = rank;
          player.squad = squad;
          player.gear = { weapon, secondary, armor, armor2, build1, build2 };
          player.builds = { build1Url, build2Url };
          player.stats = stats;
        }
      }

      renderPlayers(getFilteredPlayers());
      savePlayersToServer();
      closePlayerModal();
    }

    function deletePlayerFromModal() {
      if (!canEdit || editingPlayerId === null) return;
      const ok = confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ –∏–≥—Ä–æ–∫–∞?');
      if (!ok) return;
      allPlayers = allPlayers.filter(p => p.id !== editingPlayerId);
      renderPlayers(getFilteredPlayers());
      savePlayersToServer();
      closePlayerModal();
    }

    function closePlayerModal() {
      document.getElementById('playerModal').classList.remove('active');
      editingPlayerId = null;
    }

    function filterSquad() { 
      currentSquad = document.getElementById('squadSelect').value; 
      if (document.getElementById('squad').classList.contains('active')) {
        renderPlayers(getFilteredPlayers());
      }
    }

    function filterPlayers() {
      if (document.getElementById('squad').classList.contains('active')) {
        renderPlayers(getFilteredPlayers());
      }
    }

    // ===== –†–∏—Å–æ–≤–∞–ª–∫–∞ –∫–∞—Ä—Ç: —Ñ–æ—Ç–æ—à–æ–ø‚Äë—Å—Ç–∞–π–ª =====
    let mapCanvas = null;
    let currentTool = 'select';
    let currentMapImage = null;

    let isDrawingShape = false;
    let shapeStart = null;
    let tempShape = null;
    let isEditingObject = false;

    let currentStrokeColor = '#ff4444';
    let currentStrokeWidth = 3;
    let currentMapFileName = null; // –ø–æ —ç—Ç–æ–º—É –∫–ª—é—á—É –±—É–¥–µ–º —Å–æ—Ö—Ä–∞–Ω—è—Ç—å JSON
    let historyStack = [];
    let historyLimit = 15;
    let isRestoringHistory = false;

function setActiveToolButton(tool) {
  ['toolSelect','toolBrush','toolRect','toolCircle','toolTriangle','toolText'].forEach(id => {
    const btn = document.getElementById(id);
    if (btn) btn.classList.remove('active');
  });
  const idMap = {
    select: 'toolSelect',
    brush: 'toolBrush',
    rect: 'toolRect',
    circle: 'toolCircle',
    triangle: 'toolTriangle',
    text: 'toolText'
  };
  const activeId = idMap[tool];
  if (activeId) {
    const btn = document.getElementById(activeId);
    if (btn) btn.classList.add('active');
  }
}


function initFabricCanvas() {
  const canvasEl = document.getElementById('mapCanvas');
  const wrapper = document.getElementById('mapCanvasWrapper') || document.querySelector('.map-canvas-wrap');
  const rect = wrapper.getBoundingClientRect();
  const baseWidth = Math.min(rect.width - 40, 1200);
  const baseHeight = Math.min(rect.height - 40, 800);

  // —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –±–∞–∑–æ–≤—ã–π —Ä–∞–∑–º–µ—Ä –∫–∞–Ω–≤—ã
  canvasEl.width = baseWidth;
  canvasEl.height = baseHeight;

  mapCanvas = new fabric.Canvas('mapCanvas', {
    selection: true,
    backgroundColor: '#000'
  });

  // —Ñ–∏–∑–∏—á–µ—Å–∫–∏–π —Ä–∞–∑–º–µ—Ä —Ç–æ–∂–µ —Ñ–∏–∫—Å–∏—Ä—É–µ–º –ø–æ–¥ –±–∞–∑—É
  canvasEl.style.width = baseWidth + 'px';
  canvasEl.style.height = baseHeight + 'px';
  // –±–∞–∑–æ–≤—ã–π –∑—É–º = 1, –Ω–∏–∂–µ 1 –Ω–µ –¥–∞—ë–º
  mapCanvas.setZoom(1);

  // Delete / Backspace
  window.addEventListener('keydown', function (e) {
    if (!mapCanvas) return;
    if (e.key === 'Delete' || e.key === 'Backspace') {
      deleteSelectedShape();
    }
  });
window.addEventListener('keydown', (e) => {
  if (!mapCanvas) return;
  if (e.key.toLowerCase() === 'z' && (e.ctrlKey || e.metaKey)) {
    e.preventDefault();
    if (historyStack.length < 2) return;
    historyStack.pop();
    const prev = historyStack[historyStack.length - 1];
    if (!prev) return;
    isRestoringHistory = true;
    mapCanvas.loadFromJSON(prev, () => {
      mapCanvas.renderAll();
      isRestoringHistory = false;
    });
  }
});
  // –ó–£–ú –ö–û–õ–Å–°–ò–ö–û–ú: —Ç–æ–ª—å–∫–æ –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏–µ, –æ—Ç–¥–∞–ª—è—Ç—å—Å—è –Ω–∏–∂–µ 1 –Ω–µ–ª—å–∑—è
  mapCanvas.on('mouse:wheel', function(opt) {
    const delta = opt.e.deltaY;
    let zoom = mapCanvas.getZoom();

    // –µ—Å–ª–∏ –∫—Ä—É—Ç–∏–º "–≤–Ω–∏–∑" (–æ–±—ã—á–Ω–æ deltaY > 0) ‚Äî —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º,
    // –µ—Å–ª–∏ "–≤–≤–µ—Ä—Ö" ‚Äî —É–º–µ–Ω—å—à–∞–µ–º, –Ω–æ –Ω–µ –Ω–∏–∂–µ 1
    zoom += delta * -0.001;
    if (zoom < 1) zoom = 1;
    if (zoom > 4) zoom = 4;

    mapCanvas.zoomToPoint(
      new fabric.Point(opt.e.offsetX, opt.e.offsetY),
      zoom
    );

    // —Ä–∞–∑–º–µ—Ä –∫–∞–Ω–≤—ã –æ—Å—Ç–∞–≤–ª—è–µ–º –±–∞–∑–æ–≤—ã–º ‚Äî –∫–∞—Ä—Ç—É —Å—á–∏—Ç–∞–µ–º ¬´–∑–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω–æ–π¬ª
    canvasEl.style.width = baseWidth + 'px';
    canvasEl.style.height = baseHeight + 'px';

    opt.e.preventDefault();
    opt.e.stopPropagation();
  });

  // –ü–ê–ù–û–†–ê–ú–ò–†–û–í–ê–ù–ò–ï Shift + LMB –≤ —Ä–µ–∂–∏–º–µ —Å—Ç—Ä–µ–ª–∫–∏
  let isPanning = false;
  let lastPosX = 0, lastPosY = 0;

  mapCanvas.on('mouse:down', function(opt) {
    const evt = opt.e;
    // evt.button === 0 ‚Äî –ª–µ–≤—ã–π –∫–ª–∏–∫, evt.shiftKey ‚Äî –∑–∞–∂–∞—Ç Shift
    if (currentTool === 'select' && evt.shiftKey && evt.button === 0) {
      isPanning = true;
      lastPosX = evt.clientX;
      lastPosY = evt.clientY;
      // –æ—Ç–∫–ª—é—á–∞–µ–º –≤—ã–±–æ—Ä –æ–±—ä–µ–∫—Ç–æ–≤, —á—Ç–æ–±—ã –Ω–µ –º–µ—à–∞–ª–∏ –ø–∞–Ω–æ—Ä–∞–º–µ
      mapCanvas.selection = false;
      mapCanvas.forEachObject(o => o.evented = false);
    }
  });

  mapCanvas.on('mouse:move', function(opt) {
    if (!isPanning) return;
    const evt = opt.e;
    const vpt = mapCanvas.viewportTransform;
    vpt[4] += evt.clientX - lastPosX;
    vpt[5] += evt.clientY - lastPosY;
    mapCanvas.requestRenderAll();
    lastPosX = evt.clientX;
    lastPosY = evt.clientY;
  });

  mapCanvas.on('mouse:up', function() {
    if (!isPanning) return;
    isPanning = false;
    // –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –æ–±—ä–µ–∫—Ç–æ–≤ –∏ —Ä–µ–∂–∏–º –≤—ã–±–æ—Ä–∞
    mapCanvas.forEachObject(o => {
      if (o === currentMapImage) return;
      o.evented = true;
    });
    mapCanvas.selection = (currentTool === 'select');
  });

  mapCanvas.on('selection:created', syncUIWithSelection);
  mapCanvas.on('selection:updated', syncUIWithSelection);
  mapCanvas.on('selection:cleared', () => {
    isEditingObject = false;
  });
}




    function syncUIWithSelection() {
      if (!mapCanvas) return;
      const active = mapCanvas.getActiveObject();
      if (!active) {
        isEditingObject = false;
        return;
      }
      isEditingObject = true;

      let obj = active;
      if (active.type === 'activeSelection' && active._objects && active._objects.length) {
        obj = active._objects[0];
      }

      if (obj.stroke) {
        currentStrokeColor = obj.stroke;
        const colorInput = document.getElementById('toolColor');
        if (colorInput) colorInput.value = rgbaToHex(currentStrokeColor);
      }
      if (typeof obj.strokeWidth === 'number') {
        currentStrokeWidth = obj.strokeWidth;
        const wInput = document.getElementById('toolWidth');
        if (wInput) wInput.value = String(currentStrokeWidth);
      }
    }

function setTool(tool) {
  currentTool = tool;
  setActiveToolButton(tool);
  if (!mapCanvas) return;

  if (tool === 'brush') {
    mapCanvas.isDrawingMode = true;
    if (!mapCanvas.freeDrawingBrush) {
      mapCanvas.freeDrawingBrush = new fabric.PencilBrush(mapCanvas);
    }
    mapCanvas.freeDrawingBrush.color = currentStrokeColor;
    mapCanvas.freeDrawingBrush.width = currentStrokeWidth;
    mapCanvas.selection = false;
    mapCanvas.forEachObject(obj => {
      if (obj === currentMapImage) return;
      obj.selectable = false;
      obj.evented = false;
    });
  } else if (tool === 'select') {
    mapCanvas.isDrawingMode = false;
    mapCanvas.selection = true;
    mapCanvas.forEachObject(obj => {
      if (obj === currentMapImage) return;
      obj.selectable = true;
      obj.evented = true;
    });
  } else {
    // rect / circle / triangle / text
    mapCanvas.isDrawingMode = false;
    mapCanvas.selection = false;
    mapCanvas.forEachObject(obj => {
      if (obj === currentMapImage) return;
      obj.selectable = true;
      obj.evented = true;
    });
  }
}
    const colorEl = document.getElementById('toolColor');
    if (colorEl) {
      colorEl.addEventListener('input', () => {
        currentStrokeColor = colorEl.value || '#ff4444';

        if (mapCanvas && mapCanvas.isDrawingMode && mapCanvas.freeDrawingBrush) {
          mapCanvas.freeDrawingBrush.color = currentStrokeColor;
        }

        applyStrokePropsToSelection();
      });
    }

    const widthEl = document.getElementById('toolWidth');
    if (widthEl) {
      widthEl.addEventListener('input', () => {
        const val = Number(widthEl.value) || 1;
        currentStrokeWidth = val;

        if (mapCanvas && mapCanvas.isDrawingMode && mapCanvas.freeDrawingBrush) {
          mapCanvas.freeDrawingBrush.width = currentStrokeWidth;
        }

        applyStrokePropsToSelection();
      });
    }

    function applyStrokePropsToSelection() {
      if (!mapCanvas) return;
      const active = mapCanvas.getActiveObject();
      if (!active) return;

      if (active.type === 'activeSelection' && active._objects) {
        active._objects.forEach(obj => {
          obj.set({
            stroke: currentStrokeColor,
            strokeWidth: currentStrokeWidth
          });
        });
      } else {
        active.set({
          stroke: currentStrokeColor,
          strokeWidth: currentStrokeWidth
        });
      }

      mapCanvas.requestRenderAll();
    }

function openMapModal(name, fileName) {
  document.getElementById('mapModalTitle').textContent = name;
  currentMapFileName = fileName; // –∑–∞–ø–æ–º–∏–Ω–∞–µ–º, –∫–∞–∫–∞—è –∫–∞—Ä—Ç–∞ –æ—Ç–∫—Ä—ã—Ç–∞
  const backdrop = document.getElementById('mapModalBackdrop');
  backdrop.classList.add('active');

  setTimeout(() => {
    initFabricCanvas();
    loadMapBackground(fileName);

    // –ø–æ–ø—ã—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π JSON –¥–ª—è —ç—Ç–æ–π –∫–∞—Ä—Ç—ã
    const saved = localStorage.getItem('map_canvas_' + currentMapFileName);
    if (saved) {
      try {
        mapCanvas.loadFromJSON(saved, () => {
          mapCanvas.renderAll();
          pushHistory();
        });
      } catch (e) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–π –∫–∞—Ä—Ç—ã', e);
      }
    }

    initShapeDrawingLogic();
    setTool('select');
  }, 50);
}


function closeMapModal() {
  const backdrop = document.getElementById('mapModalBackdrop');
  backdrop.classList.remove('active');

  // —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–∏—Å—É–Ω–æ–∫ –¥–ª—è —Ç–µ–∫—É—â–µ–π –∫–∞—Ä—Ç—ã
  if (mapCanvas && currentMapFileName) {
    try {
      const json = JSON.stringify(mapCanvas.toJSON());
      localStorage.setItem('map_canvas_' + currentMapFileName, json);
    } catch (e) {
      console.error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞—Ä—Ç—É', e);
    }
  }

  if (mapCanvas) {
    mapCanvas.dispose();
    mapCanvas = null;
  }
  currentMapImage = null;
  tempShape = null;
  shapeStart = null;
  isDrawingShape = false;
  isEditingObject = false;
  currentMapFileName = null;
}


    function loadMapBackground(fileName) {
      if (!mapCanvas) return;
      const url = '/maps/' + fileName;

      fabric.Image.fromURL(url, (img) => {
        currentMapImage = img;

        const canvasWidth = mapCanvas.getWidth();
        const canvasHeight = mapCanvas.getHeight();
        const imgRatio = img.width / img.height;
        const canvasRatio = canvasWidth / canvasHeight;

        let finalWidth, finalHeight;
        if (imgRatio > canvasRatio) {
          finalWidth = canvasWidth;
          finalHeight = canvasWidth / imgRatio;
        } else {
          finalHeight = canvasHeight;
          finalWidth = canvasHeight * imgRatio;
        }

        img.set({
          left: (canvasWidth - finalWidth) / 2,
          top: (canvasHeight - finalHeight) / 2,
          selectable: false,
          evented: false
        });
        img.scaleToHeight(finalHeight);
        img.scaleToWidth(finalWidth);

        mapCanvas.setBackgroundImage(img, mapCanvas.renderAll.bind(mapCanvas));
      }, { crossOrigin: 'anonymous' });
    }

function deleteSelectedShape() {
  if (!mapCanvas) return;
  const activeObjects = mapCanvas.getActiveObjects();
  if (!activeObjects || activeObjects.length === 0) return;
  activeObjects.forEach(obj => mapCanvas.remove(obj));
  mapCanvas.discardActiveObject();
  mapCanvas.requestRenderAll();
  pushHistory();
}

function initShapeDrawingLogic() {
  if (!mapCanvas) return;

  mapCanvas.off('mouse:down');
  mapCanvas.off('mouse:move');
  mapCanvas.off('mouse:up');

  mapCanvas.on('mouse:down', function (opt) {
    const target = opt.target;

    if (isEditingObject) {
      if (!target || target === currentMapImage) {
        mapCanvas.discardActiveObject();
        mapCanvas.requestRenderAll();
        isEditingObject = false;
      }
      return;
    }

    const pointer = mapCanvas.getPointer(opt.e);

    // –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Ç–µ–∫—Å—Ç
    if (currentTool === 'text') {
      const text = prompt('–¢–µ–∫—Å—Ç:');
      if (!text) return;

      const textObj = new fabric.Textbox(text, {
        left: pointer.x,
        top: pointer.y,
        fontSize: 18,
        fill: currentStrokeColor,
        borderColor: '#4ecdc4',
        cornerColor: '#4ecdc4',
        cornerSize: 6,
        transparentCorners: false,
        hasControls: true,
        editable: true
      });

      mapCanvas.add(textObj);
      mapCanvas.setActiveObject(textObj);
      mapCanvas.requestRenderAll();
      pushHistory();
      return;
    }

    // —Ñ–∏–≥—É—Ä—ã
    if (currentTool === 'rect' || currentTool === 'circle' || currentTool === 'triangle') {
      if (target && target !== currentMapImage) return;
      isDrawingShape = true;
      shapeStart = pointer;

      const base = {
        left: pointer.x,
        top: pointer.y,
        fill: 'rgba(0,0,0,0)',
        stroke: currentStrokeColor,
        strokeWidth: currentStrokeWidth,
        strokeUniform: true,
        selectable: true
      };

      if (currentTool === 'rect') {
        tempShape = new fabric.Rect({ ...base, width: 1, height: 1 });
      } else if (currentTool === 'circle') {
        tempShape = new fabric.Circle({
          ...base,
          radius: 1,
          originX: 'center',
          originY: 'center'
        });
      } else if (currentTool === 'triangle') {
        tempShape = new fabric.Triangle({ ...base, width: 1, height: 1 });
      }

      mapCanvas.add(tempShape);
      return;
    }

    isDrawingShape = false;
    shapeStart = null;
    tempShape = null;
  });

  mapCanvas.on('mouse:move', function (opt) {
    if (!isDrawingShape || !tempShape || !shapeStart) return;
    const pointer = mapCanvas.getPointer(opt.e);

    if (currentTool === 'rect' || currentTool === 'triangle') {
      const w = pointer.x - shapeStart.x;
      const h = pointer.y - shapeStart.y;
      tempShape.set({
        width: Math.abs(w),
        height: Math.abs(h),
        left: w < 0 ? pointer.x : shapeStart.x,
        top: h < 0 ? pointer.y : shapeStart.y
      });
    } else if (currentTool === 'circle') {
      const dx = pointer.x - shapeStart.x;
      const dy = pointer.y - shapeStart.y;
      const r = Math.sqrt(dx * dx + dy * dy) / 2;
      tempShape.set({
        radius: r,
        left: shapeStart.x + dx / 2,
        top: shapeStart.y + dy / 2
      });
    }

    mapCanvas.renderAll();
  });

  mapCanvas.on('mouse:up', function () {
    if (isDrawingShape && tempShape) {
      tempShape.setCoords();
      mapCanvas.renderAll();
      isDrawingShape = false;
      shapeStart = null;
      tempShape = null;
      pushHistory();           // —Ñ–∏–≥—É—Ä—ã
    } else if (currentTool === 'brush') {
      pushHistory();           // –∫–∏—Å—Ç—å
    }
  });
    mapCanvas.on('object:modified', () => {
    pushHistory();
  });
}
    function rgbaToHex(color) {
      if (!color) return '#ff4444';
      if (color.startsWith('#')) return color;
      const m = color.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/i);
      if (!m) return '#ff4444';
      const r = Number(m[1]).toString(16).padStart(2, '0');
      const g = Number(m[2]).toString(16).padStart(2, '0');
      const b = Number(m[3]).toString(16).padStart(2, '0');
      return `#${r}${g}${b}`;
    }

    // ===== –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–ª–∞–Ω–∞ (—Ä—É—á–Ω–æ–π –≤–≤–æ–¥ + localStorage) =====

const CLAN_STATS_KEY = 'clan_stats_v1';

function loadClanStats() {
  let stats = {
    shellsDay: '0',
    shellsWeek: '0',
    ratingPlusDay: '0',
    ratingPlusWeek: '0',
    ratingMinusDay: '0',
    ratingMinusWeek: '0'
  };

  try {
    const saved = localStorage.getItem(CLAN_STATS_KEY);
    if (saved) {
      const parsed = JSON.parse(saved);
      stats = { ...stats, ...parsed };
    }
  } catch (e) {
    console.error('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è clan_stats –∏–∑ localStorage', e);
  }

  const mapIds = {
    shellsDay: 'stat-shells-day',
    shellsWeek: 'stat-shells-week',
    ratingPlusDay: 'stat-rating-plus-day',
    ratingPlusWeek: 'stat-rating-plus-week',
    ratingMinusDay: 'stat-rating-minus-day',
    ratingMinusWeek: 'stat-rating-minus-week'
  };

  Object.entries(mapIds).forEach(([key, id]) => {
    const el = document.getElementById(id);
    if (el) {
      el.textContent = stats[key];
      el.addEventListener('blur', () => saveClanStats());
      el.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          el.blur();
        }
      });
    }
  });
}

function saveClanStats() {
  const stats = {
    shellsDay: (document.getElementById('stat-shells-day')?.textContent || '0').trim(),
    shellsWeek: (document.getElementById('stat-shells-week')?.textContent || '0').trim(),
    ratingPlusDay: (document.getElementById('stat-rating-plus-day')?.textContent || '0').trim(),
    ratingPlusWeek: (document.getElementById('stat-rating-plus-week')?.textContent || '0').trim(),
    ratingMinusDay: (document.getElementById('stat-rating-minus-day')?.textContent || '0').trim(),
    ratingMinusWeek: (document.getElementById('stat-rating-minus-week')?.textContent || '0').trim()
  };

  try {
    localStorage.setItem(CLAN_STATS_KEY, JSON.stringify(stats));
  } catch (e) {
    console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è clan_stats –≤ localStorage', e);
  }
}
function pushHistory() {
  if (!mapCanvas || isRestoringHistory) return;
  const json = mapCanvas.toJSON();
  historyStack.push(json);
  if (historyStack.length > historyLimit) {
    historyStack.shift();
  }
}


(async () => {
  const ok = await loadPlayersFromServer();
  if (!ok) {
    allPlayers = [...defaultPlayers];
  }
  renderPlayers(getFilteredPlayers());
  renderSquadsBoard();
  loadClanStats();
})();
// ===== –ü—Ä–æ—Å—Ç–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (–æ–¥–∏–Ω –ª–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å) =====

// –ó–ê–î–ê–ô –°–í–û–ô –õ–û–ì–ò–ù/–ü–ê–†–û–õ–¨ –ó–î–ï–°–¨:
const AUTH_LOGIN = 'parlament';      // –ø–æ–º–µ–Ω—è–π
const AUTH_PASSWORD = '1337kv';      // –ø–æ–º–µ–Ω—è–π

const AUTH_STORAGE_KEY = 'clan_portal_auth_ok';

function checkAuthOnLoad() {
  const overlay = document.getElementById('authOverlay');
  if (!overlay) return;

  let ok = false;
  try {
    ok = localStorage.getItem(AUTH_STORAGE_KEY) === '1';
  } catch (e) {
    ok = false;
  }

  if (ok) {
    overlay.style.display = 'none';
  } else {
    overlay.style.display = 'flex';
    const loginInput = document.getElementById('authLogin');
    if (loginInput) setTimeout(() => loginInput.focus(), 50);
  }
}

function submitAuth() {
  const loginInput = document.getElementById('authLogin');
  const passInput = document.getElementById('authPassword');
  const err = document.getElementById('authError');
  if (!loginInput || !passInput) return;

  const login = loginInput.value.trim();
  const pass = passInput.value.trim();

  if (login === AUTH_LOGIN && pass === AUTH_PASSWORD) {
    try {
      localStorage.setItem(AUTH_STORAGE_KEY, '1');
    } catch (e) {}

    const overlay = document.getElementById('authOverlay');
    if (overlay) overlay.style.display = 'none';
  } else {
    if (err) err.style.display = 'block';
    passInput.value = '';
    passInput.focus();
  }
}

// –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
checkAuthOnLoad();

  </script>
</body>
</html>
